---
alwaysApply: true
---

# Deployment and Rollout Rules

## Pre-Deployment Checklist (MANDATORY)

**Before ANY version tag or deployment, verify:**

- [ ] All tests passing (`bazel test //tests:all` - pre-commit hook handles this)
- [ ] Changes committed and pushed to main
- [ ] **IF workflow changed:** Test with `act --dryrun` ‚ö†Ô∏è 
- [ ] Version number decided (ask user)
- [ ] Release notes written for tag message

**Critical:** If `.github/workflows/*.yml` modified, **MUST** run `act` before tagging!

## Rule: Always Ask About Version Before Rollout

**ALWAYS ask the user if they want to update the version before deploying/rolling out.**

**Before any deployment or rollout, ask:**
```
Do you want to tag this as a new version before deploying?
  1. Yes, create new version tag (e.g., v1.2.3)
  2. No, deploy current latest
  3. Deploy specific existing version (specify which)
```

**Rationale:**
- Versions provide clear deployment history
- Enable easy rollbacks to known good versions
- Track what was deployed when
- Follow semantic versioning best practices

## Deployment Methods

### ‚≠ê Method 1: Zero-Downtime Blue-Green Deployment (RECOMMENDED)

**Use this for all deployments.**

```bash
# 1. Commit changes
git commit -m "Add feature X"

# 2. TEST WORKFLOW WITH ACT (if workflow changed)
cd /path/to/project
source ~/.shrc
act -W .github/workflows/docker-build-push.yml -j build-and-push --dryrun

# 3. Tag release
git tag -a v1.2.3 -m "Release 1.2.3: Feature X"
git push origin v1.2.3

# 4. Wait for GitHub Actions to build image

# 5. Deploy with zero downtime
./scripts/deploy-zero-downtime.sh ~/.ssh/lightsail_visa_bulletin 1.2.3
```

**How it works:**
1. Detects active environment (blue on :8000 or green on :8001)
2. Deploys new version to inactive environment
3. Waits for health checks to pass (60s timeout)
4. Switches Nginx proxy atomically (no dropped connections)
5. Stops old environment

**Benefits:**
- ‚úÖ Zero downtime
- ‚úÖ Automatic rollback if health checks fail
- ‚úÖ Old version keeps running until new version is healthy
- ‚úÖ Safe for production traffic
- ‚úÖ Prevents ContainerConfig errors (separate container names)

### Method 2: GitHub Actions Deployment

```bash
# Trigger via CLI
source ~/.shrc && gh workflow run deploy-production.yml -f version=v1.2.3

# Or via GitHub web UI
```

## Blue-Green Deployment Architecture

**Files:**
- `docker-compose.blue.yml` - Blue environment (port 8000)
- `docker-compose.green.yml` - Green environment (port 8001)
- `scripts/deploy-zero-downtime.sh` - Blue-green deployment orchestrator

**How It Works:**

1. **Active Detection:**
   - Script checks Nginx config to see which port is active
   - Blue (8000) or Green (8001)

2. **Deploy to Inactive:**
   - Pulls new image
   - Starts containers in inactive environment
   - Uses separate container names (no conflicts)

3. **Health Checks:**
   - Waits up to 60 seconds for healthy status
   - Rolls back if health checks fail

4. **Atomic Switch:**
   - Updates Nginx proxy configuration
   - Reloads Nginx (zero dropped connections)
   - Traffic now flows to new version

5. **Cleanup:**
   - Stops old environment
   - Frees resources

**Resource Usage:**
- During deployment: 2x web containers (both running briefly)
- Normal operation: 1x web container
- Database shared between environments (no duplication)

## Rollout Flow

See `ROLLOUT_FLOW.md` for the complete step-by-step process.

## Pre-Deployment Checks

**ALWAYS run pre-deployment checks before deploying to catch configuration issues:**

```bash
# Run health checks on production environment
./scripts/pre-deploy-check.sh ~/.ssh/lightsail_visa_bulletin
```

**The script validates:**
- Port 8000 availability (detects old systemd services)
- Docker and docker-compose installation
- Nginx proxy configuration (should point to port 8000)
- SSL certificate status
- Disk space availability
- Docker service running
- Stale containers

**If checks fail:** Follow the suggested fixes before proceeding with deployment.

## Rollback Procedure

If deployment fails or issues arise:

### Quick Rollback
```bash
# Deploy previous version
./scripts/deploy.sh ~/ssh-key.pem v1.2.2
```

### Emergency Rollback (Docker ‚Üí Systemd)
```bash
ssh lightsail 'cd /opt/visa_bulletin && \
  sudo sed -i "s/127\.0\.0\.1:8001/127.0.0.1:8000/g" deployment/nginx/visa-bulletin-locations.conf && \
  sudo nginx -t && sudo systemctl reload nginx'
```

## Common Deployment Issues

### Issue: ContainerConfig KeyError

**Symptoms:**
```
ERROR: for web  'ContainerConfig'
KeyError: 'ContainerConfig'
```

**Root Cause:**
- docker-compose 1.29.2 bug when recreating containers
- Old container metadata missing `ContainerConfig` key
- Occurs when `docker-compose up` tries to inspect existing containers

**Solution:**

Use `./scripts/deploy-zero-downtime.sh` which:
- ‚úÖ Starts new containers before stopping old ones
- ‚úÖ No downtime
- ‚úÖ Avoids ContainerConfig issue (separate container names)
- ‚úÖ Automatic rollback if deployment fails

**Manual Fix (if error occurs outside deployment script):**
```bash
ssh lightsail
cd /opt/visa_bulletin
sudo docker-compose down
sudo docker-compose up -d
```

**Why Blue-Green Prevents This:**
- Separate container names (`web-blue`, `web-green`)
- No recreation - always creates fresh containers
- Old containers removed only after new ones are healthy

## Testing GitHub Actions Workflows

**üö® MANDATORY: Test workflow changes with `act` before pushing tags üö®**

**When to run `act`:**
- ‚úÖ **ALWAYS** when `.github/workflows/*.yml` files are modified
- ‚úÖ **ALWAYS** before creating a new version tag if workflow changed
- ‚úÖ When Dockerfile or docker-compose.yml changes affect build

**How to test:**
```bash
cd /path/to/project
source ~/.shrc

# Dry run (fast, checks syntax and steps)
act -W .github/workflows/docker-build-push.yml -j build-and-push --dryrun

# Full run (slower, actually builds - use for major changes)
act -W .github/workflows/docker-build-push.yml -j build-and-push
```

**Why this matters:**
- Failed workflows waste GitHub Actions minutes
- Broken tags require deletion and recreation
- Prevents deployment blockers
- Catches configuration errors before production

**If you skip this step:**
- Risk: Broken builds discovered only after pushing tag
- Impact: Deployment delays, tag management overhead
- Cost: Wasted CI/CD time and manual fixes

## Monitoring After Deployment

After any deployment:
```bash
# Check site is up
curl -I https://visa-bulletin.us

# Check Docker logs
ssh lightsail "cd /opt/visa_bulletin && sudo docker-compose -f docker-compose.test.yml logs --tail=50"

# Monitor for 10-15 minutes for errors
```
