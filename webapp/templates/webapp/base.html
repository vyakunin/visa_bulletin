{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ page_title|default:"Visa Bulletin Dashboard" }}{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    
    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdn.plot.ly" crossorigin>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="{{ page_description|default:'Independent tracker for family-sponsored and employment-based immigration priority dates. View historical trends and future projections.' }}">
    {% if canonical_url %}
    <link rel="canonical" href="{{ canonical_url }}">
    {% endif %}
    
    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="{{ og_type|default:'website' }}">
    <meta property="og:url" content="{{ og_url|default:request.build_absolute_uri }}">
    <meta property="og:title" content="{{ page_title|default:'Visa Bulletin Dashboard' }}">
    <meta property="og:description" content="{{ page_description|default:'Track priority dates and see projections.' }}">
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'favicon.svg' %}">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="{{ og_url|default:request.build_absolute_uri }}">
    <meta property="twitter:title" content="{{ page_title|default:'Visa Bulletin Dashboard' }}">
    <meta property="twitter:description" content="{{ page_description|default:'Track priority dates and see projections.' }}">
    
    <!-- Structured Data (JSON-LD) -->
    {% if structured_data %}
    <script type="application/ld+json">
        {{ structured_data|safe }}
    </script>
    {% endif %}
    
    <!-- Critical CSS (inlined for faster render) -->
    <style>
        /* Bootstrap Critical CSS - Container, Grid, Forms, Buttons */
        *,::after,::before{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff}
        h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}
        h1{font-size:2.5rem}h2{font-size:2rem}h3{font-size:1.75rem}h5{font-size:1.25rem}
        p{margin-top:0;margin-bottom:1rem}
        .container{width:100%;padding-right:var(--bs-gutter-x,.75rem);padding-left:var(--bs-gutter-x,.75rem);margin-right:auto;margin-left:auto}
        @media (min-width:576px){.container{max-width:540px}}
        @media (min-width:768px){.container{max-width:720px}}
        @media (min-width:992px){.container{max-width:960px}}
        @media (min-width:1200px){.container{max-width:1140px}}
        .row{--bs-gutter-x:1.5rem;--bs-gutter-y:0;display:flex;flex-wrap:wrap;margin-top:calc(var(--bs-gutter-y) * -1);margin-right:calc(var(--bs-gutter-x) * -.5);margin-left:calc(var(--bs-gutter-x) * -.5)}
        .col-12{flex:0 0 auto;width:100%}
        .g-3{--bs-gutter-x:1rem;--bs-gutter-y:1rem}
        .card{position:relative;display:flex;flex-direction:column;min-width:0;word-wrap:break-word;background-color:#fff;background-clip:border-box;border:1px solid rgba(0,0,0,.125);border-radius:.25rem}
        .card-header{padding:.5rem 1rem;margin-bottom:0;background-color:rgba(0,0,0,.03);border-bottom:1px solid rgba(0,0,0,.125)}
        .card-body{flex:1 1 auto;padding:1rem}
        .form-label{margin-bottom:.5rem;font-weight:500}
        .form-control,.form-select{display:block;width:100%;padding:.375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;background-clip:padding-box;border:1px solid #ced4da;appearance:none;border-radius:.25rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        .form-control:focus,.form-select:focus{color:#212529;background-color:#fff;border-color:#86b7fe;outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}
        .btn{display:inline-block;font-weight:400;line-height:1.5;color:#212529;text-align:center;text-decoration:none;vertical-align:middle;cursor:pointer;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;border-radius:.25rem;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out}
        .btn-primary{color:#fff;background-color:#0d6efd;border-color:#0d6efd}
        .btn-primary:hover{color:#fff;background-color:#0b5ed7;border-color:#0a58ca}
        .w-100{width:100%!important}
        .mt-4{margin-top:1.5rem!important}
        .mb-0{margin-bottom:0!important}
        .mb-2{margin-bottom:.5rem!important}
        .mb-3{margin-bottom:1rem!important}
        .text-white{color:#fff!important}
        .text-center{text-align:center!important}
        .alert{position:relative;padding:1rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.25rem}
        .alert-info{color:#055160;background-color:#cff4fc;border-color:#b6effb}
        .alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5}
        .alert-heading{color:inherit}
        .visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important}
        .spinner-border{display:inline-block;width:2rem;height:2rem;vertical-align:-.125em;border:.25em solid currentColor;border-right-color:transparent;border-radius:50%;animation:.75s linear infinite spinner-border}
        @keyframes spinner-border{to{transform:rotate(360deg)}}
        .text-primary{color:#0d6efd!important}
        .text-muted{color:#6c757d!important}
        .small{font-size:.875em}
        .lead{font-size:1.25rem;font-weight:300}
        .display-4{font-size:3.5rem;font-weight:300;line-height:1.2}
    </style>
    
    <!-- Full Bootstrap CSS (async load) -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></noscript>
    
    <!-- Bootstrap Icons (deferred - not critical for initial render) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"></noscript>
    
    <!-- Analytics (Privacy-focused, GDPR compliant) -->
    {% if analytics_script %}
    {{ analytics_script|safe }}
    {% endif %}
    
    <!-- Custom CSS - Government Official Theme -->
    <style>
        /* Font Optimization */
        @font-face {
            font-family: 'Bootstrap-icons';
            src: url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/fonts/bootstrap-icons.woff2?524846017b983fc8ded9325d94ed40f3") format('woff2'),
                 url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/fonts/bootstrap-icons.woff?524846017b983fc8ded9325d94ed40f3") format('woff');
            font-display: swap; /* Prevent layout shift during font load */
        }

        :root {
            --gov-navy: #003366;
            --gov-red: #B31942;
            --gov-gold: #D4AF37;
            --gov-green: #2D7A3E;
            --gov-background: #F5F7FA;
            --gov-text: #1A1A1A;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--gov-background);
            color: var(--gov-text);
        }
        
        /* Prevent layout shift by reserving minimum space */
        main {
            min-height: 600px;
        }
        
        /* Reserve space for dashboard content to prevent CLS */
        .container.mt-4 {
            min-height: 1800px !important; /* Increased and forced to prevent any container shift */
        }
        
        /* Alternative: apply to body for full page height */
        body > .container.mt-4 {
            min-height: 1800px !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: Georgia, serif;
            font-weight: normal;
        }
        
        .hero-section {
            background: var(--gov-navy);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-bottom: 4px solid var(--gov-red);
        }
        
        .hero-section h1 {
            font-family: Georgia, serif;
            font-weight: normal;
        }
        
        .filter-card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            border: 1px solid #d0d0d0;
            border-radius: 2px;
            min-height: 420px; /* Prevent layout shift */
        }
        
        .filter-card .card-header {
            background: var(--gov-navy) !important;
            border-bottom: 2px solid var(--gov-red);
        }
        
        .btn-primary {
            background-color: var(--gov-red);
            border-color: var(--gov-red);
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background-color: #9a1436;
            border-color: #9a1436;
        }
        
        .projection-alert {
            border-left: 6px solid var(--gov-navy);
            background-color: #e8f4f8;
            border-radius: 2px;
            min-height: 280px; /* Reserve space for projection cards - prevents CLS */
        }
        
        .footer-link {
            color: var(--footer-link-color);
            text-decoration: underline;
        }
        
        .card {
            border: 1px solid #d0d0d0;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-select, .form-control {
            border: 2px solid #E8E8E8;
            border-radius: 2px;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: var(--gov-navy);
            box-shadow: 0 0 0 0.2rem rgba(0, 51, 102, 0.15);
        }
        
        .badge.bg-success {
            background-color: var(--gov-green) !important;
        }
        
        footer {
            background-color: var(--gov-navy);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        footer hr {
            border-color: rgba(255,255,255,0.2);
        }
        
        footer p {
            color: #FFFFFF; /* Pure white for better contrast on navy (WCAG AA) */
        }
        
        .alert-info {
            background-color: #e8f4f8;
            border-color: var(--gov-navy);
        }
        
        .alert-warning {
            background-color: #fff9e6;
            border-color: var(--gov-gold);
            border-left: 6px solid var(--gov-gold);
        }
        
        .text-success {
            color: var(--gov-green) !important;
        }
        
        .bi {
            margin-right: 6px;
        }
        
        /* Navigation Colors */
        :root {
            --nav-inactive-text: #4a5568;      /* Medium gray for inactive links */
            --nav-inactive-bg: transparent;     /* No background for inactive */
            --nav-hover-text: #1a365d;         /* Dark blue on hover */
            --nav-hover-bg: #f7fafc;           /* Light gray background on hover */
            --nav-active-text: #ffffff;        /* White text for active */
            --nav-active-bg: #2c5282;          /* Strong blue background for active */
            --nav-border-color: #e2e8f0;       /* Border color */
            --footer-link-color: #0052A3;      /* Darker blue for footer links - WCAG AA (4.8:1 on gray) */
        }
        
        /* Navigation Bar */
        .navbar-compact {
            background-color: white;
            border-bottom: 1px solid var(--nav-border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 0.5rem 0;
        }
        
        .navbar-compact .nav-link {
            color: var(--nav-inactive-text);
            background-color: var(--nav-inactive-bg);
            font-size: 0.95rem;
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .navbar-compact .nav-link:hover {
            color: var(--nav-hover-text);
            background-color: var(--nav-hover-bg);
        }
        
        .navbar-compact .nav-link.active {
            color: var(--nav-active-text) !important;
            background-color: var(--nav-active-bg) !important;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(44, 82, 130, 0.3);
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .hero-section {
                padding: 1.5rem 0;
            }
            .hero-section h1 {
                font-size: 1.75rem;
            }
            .hero-section p {
                font-size: 0.95rem;
            }
            .filter-card .card-body {
                padding: 1rem;
            }
            .filter-card label {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }
            .filter-card select, .filter-card input {
                font-size: 0.9rem;
            }
            /* Make chart responsive on mobile */
            #chart-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* Reduce projection alert padding */
            .projection-alert {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            .projection-alert h5 {
                font-size: 1rem;
            }
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <h1 class="display-4"><i class="bi bi-graph-up-arrow"></i> U.S. Visa Bulletin Dashboard</h1>
            <p class="lead">Independent tracker for family-sponsored and employment-based immigration priority dates</p>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <nav class="navbar-compact">
        <div class="container">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'dashboard' %}">
                        <i class="bi bi-house-door"></i> Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/faq/' %}active{% endif %}" href="{% url 'faq' %}">
                        <i class="bi bi-question-circle"></i> FAQ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/about/' %}active{% endif %}" href="{% url 'about' %}">
                        <i class="bi bi-info-circle"></i> About
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/contact/' %}active{% endif %}" href="{% url 'contact' %}">
                        <i class="bi bi-envelope"></i> Contact
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>
    
    <footer class="container mt-5 mb-4">
        <hr style="border-color: rgba(255,255,255,0.2);">
        
        <div class="text-center mb-3" style="color: #8FA3B8; font-size: 0.95rem;">
            <p class="mb-2">
                <strong>Built to help the community</strong> â€” I created this tracker to make visa bulletin data easier to understand. 
                If you find it useful, please share it with others in the immigration community.
            </p>
            
            <!-- Share Buttons -->
            <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                <!-- WhatsApp -->
                <a href="whatsapp://send?text=Check%20out%20this%20Visa%20Bulletin%20Dashboard%20to%20track%20priority%20dates:%20https://visa-bulletin.us/" 
                   class="btn btn-success btn-sm">
                    <i class="bi bi-whatsapp"></i> WhatsApp
                </a>
                
                <!-- Telegram -->
                <a href="https://t.me/share/url?url=https://visa-bulletin.us/&text=Check%20out%20this%20Visa%20Bulletin%20Dashboard%20to%20track%20priority%20dates" 
                   class="btn btn-primary btn-sm text-white">
                    <i class="bi bi-telegram"></i> Telegram
                </a>
                
                <!-- Twitter/X -->
                <a href="https://twitter.com/intent/tweet?text=Check%20out%20this%20Visa%20Bulletin%20Dashboard%20to%20track%20priority%20dates&url=https://visa-bulletin.us/" 
                   class="btn btn-dark btn-sm">
                    <i class="bi bi-twitter-x"></i> Post
                </a>
                
                <!-- Copy Link -->
                <button onclick="navigator.clipboard.writeText('https://visa-bulletin.us/'); alert('Link copied!')" 
                        class="btn btn-secondary btn-sm">
                    <i class="bi bi-clipboard"></i> Copy Link
                </button>
            </div>
            
            <p class="mb-2">
                <i class="bi bi-envelope"></i> Questions or feedback? Email <a href="mailto:vyakunin@gmail.com" class="footer-link">vyakunin@gmail.com</a>
                <br>
                <i class="bi bi-github"></i> View source code on <a href="https://github.com/vyakunin/visa_bulletin" target="_blank" rel="noopener" class="footer-link">GitHub</a>
            </p>
        </div>
        
        <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">
        
        <p class="text-center" style="color: #8FA3B8; font-size: 0.85rem;">
            Data sourced from U.S. Department of State Visa Bulletins. 
            Projections are estimates based on historical trends and should not be considered official guidance.
        </p>
    </footer>
    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    
    <!-- Plotly.js Lazy Loading -->
    <!-- Only load Plotly when chart container is visible (saves 332KB on initial load) -->
    <script>
        let plotlyLoaded = false;
        let plotlyLoadCallbacks = [];
        
        function loadPlotly(callback) {
            if (plotlyLoaded) {
                if (callback) callback();
                return;
            }
            
            if (callback) {
                plotlyLoadCallbacks.push(callback);
            }
            
            // Only start loading once
            if (plotlyLoadCallbacks.length > 1) return;
            
            const script = document.createElement('script');
            script.src = 'https://cdn.plot.ly/plotly-basic-2.32.0.min.js';
            script.charset = 'utf-8';
            script.onload = function() {
                plotlyLoaded = true;
                plotlyLoadCallbacks.forEach(cb => cb());
                plotlyLoadCallbacks = [];
            };
            document.head.appendChild(script);
        }
        
        // Lazy load when chart container is visible
        document.addEventListener('DOMContentLoaded', function() {
            const chartContainer = document.getElementById('chart-container');
            if (chartContainer) {
                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting) {
                        loadPlotly(function() {
                            // Trigger any chart rendering after Plotly loads
                            const renderEvent = new Event('plotlyLoaded');
                            document.dispatchEvent(renderEvent);
                        });
                        observer.disconnect();
                    }
                }, {
                    rootMargin: '50px' // Start loading 50px before visible
                });
                observer.observe(chartContainer);
            }
        });
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>

