{% extends "webapp/base.html" %}

{% block container_class %}dashboard-container{% endblock %}

{% block content %}
<main>
<div class="row">
    <div class="col-12">
        <!-- Filter Card -->
        <div class="card filter-card">
            <div class="card-header bg-primary text-white">
                <h2 class="h5 mb-0"><i class="bi bi-funnel"></i> Filter Options</h2>
            </div>
            <div class="card-body">
                <form method="get" action="" id="filterForm">
                    <div class="row g-3">
                        <!-- Visa Category -->
                        <div class="col-12">
                            <label for="category" class="form-label">Visa Category</label>
                            <select class="form-select" id="category" name="category" onchange="updateVisaClasses()">
                                {% for value, label in visa_categories %}
                                <option value="{{ value }}" {% if value == category %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Country -->
                        <div class="col-12">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country" name="country" onchange="autoSubmitForm()">
                                {% for value, label in countries %}
                                <option value="{{ value }}" {% if value == country %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Action Type -->
                        <div class="col-12">
                            <label for="action_type" class="form-label">Action Type</label>
                            <select class="form-select" id="action_type" name="action_type" onchange="autoSubmitForm()">
                                {% for value, label in action_types %}
                                <option value="{{ value }}" {% if value == action_type %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Submission Date -->
                        <div class="col-12">
                            <label for="submission_date" class="form-label">Priority Date</label>
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="submission_date" 
                                       name="submission_date" 
                                       value="{{ submission_date|date:'m/d/Y' }}"
                                       placeholder="MM/DD/YYYY"
                                       pattern="\d{1,2}/\d{1,2}/\d{4}"
                                       inputmode="numeric"
                                       autocomplete="off"
                                       maxlength="10">
                                <button class="btn btn-outline-secondary" type="button" id="datePickerBtn" 
                                        title="Open calendar">
                                    <i class="bi bi-calendar3"></i>
                                </button>
                                <input type="date" id="datePickerHidden" class="visually-hidden" tabindex="-1">
                            </div>
                            <small class="form-text text-muted">Format: MM/DD/YYYY (e.g., 03/15/2022)</small>
                            <div class="invalid-feedback" id="dateError">Please enter a valid date (MM/DD/YYYY)</div>
                        </div>
                        
                        <!-- Update Button -->
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Update Analysis
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        {% if not has_data %}
            <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading"><i class="bi bi-graph-up-arrow"></i> No Data Available</h5>
                <p>No visa bulletin data found for the selected combination:</p>
                <ul class="mb-2">
                    <li><strong>Category:</strong> {{ category_display }}</li>
                    <li><strong>Country:</strong> {{ country_display }}</li>
                    <li><strong>Action Type:</strong> {{ action_type_display }}</li>
                </ul>
                <hr>
                <p class="mb-1"><strong>Suggestions:</strong></p>
                <ul class="mb-0">
                    <li>Try selecting "All Chargeability Areas" for the country filter</li>
                    <li>Try a different visa category</li>
                    <li>Some older bulletins may not have data for all categories</li>
                    <li>Make sure you have imported bulletin data: <code>bazel run //:refresh_data -- --save-to-db</code></li>
                </ul>
            </div>
        {% endif %}
        
        {% if has_data %}
            <!-- Projection Results for Each Visa Class -->
            {% if visa_class_data %}
            <div class="alert projection-alert alert-info" role="alert">
                <h3 class="h5 alert-heading"><i class="bi bi-calendar-check"></i> Processing Estimates by Visa Class</h3>
                <p class="mb-2 small text-muted">
                    Hover over the projection lines in the chart below to see estimated dates for each visa class.
                </p>
                <div class="row">
                    {% for data in visa_class_data %}
                    {% with projection=data.projection %}
                    {% if projection and projection.estimated_date %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="card">
                            <div class="card-body py-2 px-3">
                                <h4 class="card-title mb-1 h6">{{ data.visa_class_label|default:data.visa_class }}</h4>
                                {% if projection.status == 'projected' or projection.status == 'projected_historical' %}
                                <p class="mb-0 small">
                                    <strong>Est. {{ projection.estimated_date|date:"F Y" }}</strong>
                                </p>
                                <p class="mb-0 small text-muted">
                                    {{ projection.avg_progress_days_per_month }} days/month
                                </p>
                                {% elif projection.status == 'current' %}
                                <p class="mb-0 small text-success"><i class="bi bi-check-circle-fill"></i> Current</p>
                                {% elif projection.status == 'no_movement' %}
                                <p class="mb-0 small text-warning"><i class="bi bi-exclamation-triangle"></i> No movement</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                    {% endfor %}
                </div>
                <hr class="my-2">
                <p class="mb-0 small">
                    <i class="bi bi-exclamation-triangle"></i> <em>These are rough estimates based on historical trends. Actual processing times may vary significantly due to policy changes, backlogs, and other factors.</em>
                    <a href="{% url 'about' %}" style="color: #0066CC; text-decoration: underline;" class="ms-1">How are projections calculated? →</a>
                </p>
            </div>
            {% endif %}
            
            <!-- Chart -->
            <div class="card" id="chart-container">
                <div class="card-body">
                    <!-- Visa Class Checkboxes -->
                    <div class="mb-3">
                        <div class="d-flex flex-wrap align-items-center gap-2 gap-md-3">
                            <span class="text-muted small me-1"><i class="bi bi-eye"></i> Show:</span>
                            {% for trace in chart_data.trace_info %}
                            <div class="form-check form-check-inline mb-0">
                                <input class="form-check-input visa-class-toggle" 
                                       type="checkbox" 
                                       id="toggle-{{ trace.visa_class }}" 
                                       data-trace-indices="{{ trace.trace_indices|join:',' }}"
                                       checked>
                                <label class="form-check-label small" for="toggle-{{ trace.visa_class }}" style="color: {{ trace.color }}; font-weight: 500;">
                                    {{ trace.label }}
                                </label>
                            </div>
                            {% endfor %}
                            <!-- Priority date always shown (not toggleable) -->
                            <div class="form-check form-check-inline mb-0">
                                <input class="form-check-input" type="checkbox" checked disabled>
                                <label class="form-check-label small" style="color: red; font-weight: 500;">
                                    Your Priority Date
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-light py-2 mb-3" role="alert">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Click data points to view official bulletins.
                        </small>
                    </div>
                    <div id="chart-content">
                        <div class="text-center py-5" id="chart-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                            <p class="text-muted mt-2">Loading chart...</p>
                        </div>
                        <div id="chart-plot" style="display:none;">
                            <div id="priority-date-chart" class="plotly-graph-div" style="width:100%; max-width:100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Info Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> About This Dashboard</h5>
            </div>
            <div class="card-body">
                <h6>What is a Priority Date?</h6>
                <p>
                    The priority date is the date when your immigration petition was filed. The Visa Bulletin publishes 
                    "cutoff dates" each month, which determine whose cases can move forward based on their priority dates.
                    <a href="{% url 'faq' %}#headingThree" class="text-decoration-none">Learn more about priority dates →</a>
                </p>
                
                <h6>How to Use This Dashboard</h6>
                <ol>
                    <li>Select your <strong>visa category</strong> (Family-Sponsored or Employment-Based)</li>
                    <li>Choose your <strong>country of chargeability</strong> (birth country, not citizenship)</li>
                    <li>Choose <strong>Final Action</strong> (for green card approval) or <strong>Filing</strong> (to submit I-485). <a href="{% url 'faq' %}#headingTwo" class="text-decoration-none">What's the difference? →</a></li>
                    <li>Enter your application <strong>priority date</strong> to see estimated processing timelines</li>
                </ol>
                
                <h6>Understanding the Chart</h6>
                <ul>
                    <li><strong>Solid lines</strong>: Historical priority date cutoffs for each visa class</li>
                    <li><strong>Red dashed line</strong>: Your application's priority date</li>
                    <li><strong>Dashed projection lines</strong>: Projected timelines for each visa class based on recent trends</li>
                    <li><strong>Click on any data point</strong>: Opens the official visa bulletin for that month</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-question-circle"></i> <strong>Have questions?</strong> 
                    Check out our <a href="{% url 'faq' %}" class="alert-link">Frequently Asked Questions</a> page 
                    for answers about PERM processing, priority dates, retrogressions, and more.
                </div>
            </div>
        </div>
    </div>
</div>
</main>

<script>
// Save scroll position before form submit
function saveScrollPosition() {
    sessionStorage.setItem('scrollPosition', window.scrollY || window.pageYOffset);
}

// Auto-submit for dropdowns (but not for date input)
function autoSubmitForm() {
    saveScrollPosition();
    document.getElementById('filterForm').submit();
}

// Category change needs to update visa classes AND submit
function updateVisaClasses() {
    saveScrollPosition();
    document.getElementById('filterForm').submit();
}

// Restore scroll position after page load
window.addEventListener('load', function() {
    const scrollPosition = sessionStorage.getItem('scrollPosition');
    if (scrollPosition !== null) {
        window.scrollTo({
            top: parseInt(scrollPosition),
            behavior: 'instant' // Instant scroll, no animation
        });
        sessionStorage.removeItem('scrollPosition'); // Clean up
    }
});

// Date input handling
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('submission_date');
    const datePickerBtn = document.getElementById('datePickerBtn');
    const datePickerHidden = document.getElementById('datePickerHidden');
    const dateError = document.getElementById('dateError');
    
    if (dateInput) {
        // Auto-format as user types (add slashes)
        dateInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            let formatted = '';
            
            if (value.length > 0) {
                // Month (first 2 digits)
                formatted = value.substring(0, 2);
                if (value.length > 2) {
                    // Add slash and day
                    formatted += '/' + value.substring(2, 4);
                    if (value.length > 4) {
                        // Add slash and year
                        formatted += '/' + value.substring(4, 8);
                    }
                }
            }
            
            e.target.value = formatted;
            validateDate();
        });
        
        // Submit on Enter key
        dateInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (validateDate()) {
                    saveScrollPosition();
                    document.getElementById('filterForm').submit();
                }
            }
        });
        
        // Validate on blur
        dateInput.addEventListener('blur', validateDate);
    }
    
    // Calendar button opens native picker
    if (datePickerBtn && datePickerHidden) {
        datePickerBtn.addEventListener('click', function() {
            // Sync current value to hidden picker
            const mmddyyyy = dateInput.value;
            if (mmddyyyy && mmddyyyy.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const parts = mmddyyyy.split('/');
                datePickerHidden.value = `${parts[2]}-${parts[0]}-${parts[1]}`; // YYYY-MM-DD
            }
            datePickerHidden.showPicker();
        });
        
        // When user selects from calendar, update text input
        datePickerHidden.addEventListener('change', function() {
            if (this.value) {
                const parts = this.value.split('-'); // YYYY-MM-DD
                dateInput.value = `${parts[1]}/${parts[2]}/${parts[0]}`; // MM/DD/YYYY
                validateDate();
            }
        });
    }
    
    // Validation function
    function validateDate() {
        const value = dateInput.value;
        
        // Empty is valid (optional field)
        if (!value) {
            dateInput.classList.remove('is-invalid');
            return true;
        }
        
        // Check format
        if (!value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
            dateInput.classList.add('is-invalid');
            return false;
        }
        
        const parts = value.split('/');
        const month = parseInt(parts[0], 10);
        const day = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);
        
        // Validate ranges
        if (month < 1 || month > 12) {
            dateInput.classList.add('is-invalid');
            return false;
        }
        
        if (day < 1 || day > 31) {
            dateInput.classList.add('is-invalid');
            return false;
        }
        
        // Reasonable year range for priority dates (1990-2030)
        if (year < 1990 || year > 2030) {
            dateInput.classList.add('is-invalid');
            return false;
        }
        
        // Check if date actually exists
        const testDate = new Date(year, month - 1, day);
        if (testDate.getMonth() !== month - 1 || testDate.getDate() !== day) {
            dateInput.classList.add('is-invalid');
            return false;
        }
        
        dateInput.classList.remove('is-invalid');
        return true;
    }
    
    // Chart initialization and checkbox handling
    {% if chart_data %}
    var chartInitialized = false;
    
    function initChart() {
        if (typeof Plotly === 'undefined') {
            // If Plotly hasn't loaded yet, wait and try again
            setTimeout(initChart, 50);
            return;
        }
        
        if (chartInitialized) return;
        chartInitialized = true;
        
        var chartData = {{ chart_data.chart_json|safe }};
        
        // Disable autorange on layout to prevent default reset behavior
        chartData.layout.xaxis.autorange = false;
        chartData.layout.yaxis.autorange = false;
        
        var config = {
            'displayModeBar': true,
            'displaylogo': false,
            'responsive': true,
            'doubleClick': false,  // Disable default double-click reset
            'modeBarButtonsToRemove': ['pan2d', 'select2d', 'lasso2d', 'autoScale2d', 'resetScale2d'],
            'toImageButtonOptions': {
                'format': 'png',
                'filename': 'visa_bulletin_chart',
                'height': 800,
                'width': 1200,
                'scale': 2
            }
        };
        
        Plotly.newPlot('priority-date-chart', chartData.data, chartData.layout, config).then(function(gd) {
            // Store initial smart range
            var initialRange = calculateVisibleRange();
            
            // Set initial range to exclude priority date line
            if (initialRange.xMin && initialRange.xMax && initialRange.yMin && initialRange.yMax) {
                Plotly.relayout('priority-date-chart', {
                    'xaxis.range': [initialRange.xMin, initialRange.xMax],
                    'yaxis.range': [initialRange.yMin, initialRange.yMax]
                });
            }
            
            // Show chart, hide loading
            document.getElementById('chart-loading').style.display = 'none';
            document.getElementById('chart-plot').style.display = 'block';
            
            // Add click handler for bulletin links
            gd.on('plotly_click', function(data) {
                var point = data.points[0];
                if (point.customdata) {
                    window.open(point.customdata, '_blank');
                }
            });
            
            // Intercept relayout events (including double-click resets)
            gd.on('plotly_relayout', function(eventdata) {
                // If autorange was triggered (e.g., by toolbar reset button)
                if (eventdata['xaxis.autorange'] || eventdata['yaxis.autorange']) {
                    // Override with our smart range
                    setTimeout(function() {
                        var range = calculateVisibleRange();
                        if (range.xMin && range.xMax && range.yMin && range.yMax) {
                            Plotly.relayout('priority-date-chart', {
                                'xaxis.range': [range.xMin, range.xMax],
                                'yaxis.range': [range.yMin, range.yMax],
                                'xaxis.autorange': false,
                                'yaxis.autorange': false
                            });
                        }
                    }, 10);
                }
            });
            
            // Helper to calculate range from visible data traces only
            function calculateVisibleRange() {
                var data = gd.data;
                var xMin = null, xMax = null, yMin = null, yMax = null;
                
                // Iterate through all traces except the last one (priority date line)
                for (var i = 0; i < data.length - 1; i++) {
                    var trace = data[i];
                    
                    // Skip hidden traces
                    if (trace.visible === 'legendonly' || trace.visible === false) {
                        continue;
                    }
                    
                    // Get min/max from this trace
                    if (trace.x && trace.y) {
                        for (var j = 0; j < trace.x.length; j++) {
                            var x = new Date(trace.x[j]).getTime();
                            var y = trace.y[j] ? new Date(trace.y[j]).getTime() : null;
                            
                            if (x && (xMin === null || x < xMin)) xMin = x;
                            if (x && (xMax === null || x > xMax)) xMax = x;
                            if (y && (yMin === null || y < yMin)) yMin = y;
                            if (y && (yMax === null || y > yMax)) yMax = y;
                        }
                    }
                }
                
                // Add 5% padding
                if (xMin !== null && xMax !== null) {
                    var xPadding = (xMax - xMin) * 0.05;
                    xMin = new Date(xMin - xPadding);
                    xMax = new Date(xMax + xPadding);
                }
                
                if (yMin !== null && yMax !== null) {
                    var yPadding = (yMax - yMin) * 0.05;
                    yMin = new Date(yMin - yPadding);
                    yMax = new Date(yMax + yPadding);
                }
                
                return {
                    xMin: xMin,
                    xMax: xMax,
                    yMin: yMin,
                    yMax: yMax
                };
            }
            
            // Setup checkbox handlers for instant trace toggling
            document.querySelectorAll('.visa-class-toggle').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    var traceIndices = this.dataset.traceIndices.split(',').map(Number);
                    var visible = this.checked ? true : 'legendonly';
                    
                    // Update trace visibility
                    traceIndices.forEach(function(idx) {
                        Plotly.restyle('priority-date-chart', {'visible': visible}, [idx]);
                    });
                    
                    // Auto-rescale to fit visible data only (excludes priority date line)
                    setTimeout(function() {
                        var range = calculateVisibleRange();
                        if (range.xMin && range.xMax && range.yMin && range.yMax) {
                            Plotly.relayout('priority-date-chart', {
                                'xaxis.range': [range.xMin, range.xMax],
                                'yaxis.range': [range.yMin, range.yMax]
                            });
                        }
                    }, 50);
                });
            });
        });
    }
    
    initChart();
    {% endif %}
});
</script>
{% endblock %}

