{% extends "webapp/base.html" %}

{% block content %}
<main>
<div class="row">
    <div class="col-12">
        <!-- Filter Card -->
        <div class="card filter-card">
            <div class="card-header bg-primary text-white">
                <h2 class="h5 mb-0"><i class="bi bi-funnel"></i> Filter Options</h2>
            </div>
            <div class="card-body">
                <form method="get" action="" id="filterForm">
                    <div class="row g-3">
                        <!-- Visa Category -->
                        <div class="col-12">
                            <label for="category" class="form-label">Visa Category</label>
                            <select class="form-select" id="category" name="category" onchange="updateVisaClasses()">
                                {% for value, label in visa_categories %}
                                <option value="{{ value }}" {% if value == category %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Country -->
                        <div class="col-12">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country" name="country" onchange="autoSubmitForm()">
                                {% for value, label in countries %}
                                <option value="{{ value }}" {% if value == country %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Action Type -->
                        <div class="col-12">
                            <label for="action_type" class="form-label">Action Type</label>
                            <select class="form-select" id="action_type" name="action_type" onchange="autoSubmitForm()">
                                {% for value, label in action_types %}
                                <option value="{{ value }}" {% if value == action_type %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Submission Date -->
                        <div class="col-12">
                            <label for="submission_date" class="form-label">Priority Date</label>
                            <input type="date" class="form-control" id="submission_date" name="submission_date" 
                                   value="{{ submission_date|date:'Y-m-d' }}">
                            <small class="form-text text-muted">Your filing date</small>
                        </div>
                        
                        <!-- Update Button -->
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-clockwise"></i> Update Analysis
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        {% if not has_data %}
            <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading"><i class="bi bi-graph-up-arrow"></i> No Data Available</h5>
                <p>No visa bulletin data found for the selected combination:</p>
                <ul class="mb-2">
                    <li><strong>Category:</strong> {{ category_display }}</li>
                    <li><strong>Country:</strong> {{ country_display }}</li>
                    <li><strong>Action Type:</strong> {{ action_type_display }}</li>
                </ul>
                <hr>
                <p class="mb-1"><strong>Suggestions:</strong></p>
                <ul class="mb-0">
                    <li>Try selecting "All Chargeability Areas" for the country filter</li>
                    <li>Try a different visa category</li>
                    <li>Some older bulletins may not have data for all categories</li>
                    <li>Make sure you have imported bulletin data: <code>bazel run //:refresh_data -- --save-to-db</code></li>
                </ul>
            </div>
        {% endif %}
        
        {% if has_data %}
            <!-- Projection Results for Each Visa Class -->
            {% if visa_class_data %}
            <div class="alert projection-alert alert-info" role="alert">
                <h3 class="h5 alert-heading"><i class="bi bi-calendar-check"></i> Processing Estimates by Visa Class</h3>
                <p class="mb-2 small text-muted">
                    Hover over the projection lines in the chart below to see estimated dates for each visa class.
                </p>
                <div class="row">
                    {% for data in visa_class_data %}
                    {% with projection=data.projection %}
                    {% if projection and projection.estimated_date %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="card">
                            <div class="card-body py-2 px-3">
                                <h6 class="card-title mb-1">{{ data.visa_class_label|default:data.visa_class }}</h6>
                                {% if projection.status == 'projected' or projection.status == 'projected_historical' %}
                                <p class="mb-0 small">
                                    <strong>Est. {{ projection.estimated_date|date:"F Y" }}</strong>
                                </p>
                                <p class="mb-0 small text-muted">
                                    {{ projection.avg_progress_days_per_month }} days/month
                                </p>
                                {% elif projection.status == 'current' %}
                                <p class="mb-0 small text-success"><i class="bi bi-check-circle-fill"></i> Current</p>
                                {% elif projection.status == 'no_movement' %}
                                <p class="mb-0 small text-warning"><i class="bi bi-exclamation-triangle"></i> No movement</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                    {% endfor %}
                </div>
                <hr class="my-2">
                <p class="mb-0 small">
                    <i class="bi bi-exclamation-triangle"></i> <em>These are rough estimates based on historical trends. Actual processing times may vary significantly due to policy changes, backlogs, and other factors.</em>
                    <a href="{% url 'about' %}" style="color: #0066CC; text-decoration: underline;" class="ms-1">How are projections calculated? →</a>
                </p>
            </div>
            {% endif %}
            
            <!-- Chart -->
            <div class="card" id="chart-container">
                <div class="card-body">
                    <div class="alert alert-light py-2 mb-3" role="alert">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> <strong>Chart Tips:</strong> Click a visa class in the legend to show/hide it. Double-click to isolate only that class. Click data points to view official bulletins.
                        </small>
                    </div>
                    <div id="chart-content">
                        <div class="text-center py-5" id="chart-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                            <p class="text-muted mt-2">Loading chart...</p>
                        </div>
                        <div id="chart-plot" style="display:none;">
                            {{ chart_html|safe }}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Info Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> About This Dashboard</h5>
            </div>
            <div class="card-body">
                <h6>What is a Priority Date?</h6>
                <p>
                    The priority date is the date when your immigration petition was filed. The Visa Bulletin publishes 
                    "cutoff dates" each month, which determine whose cases can move forward based on their priority dates.
                    <a href="{% url 'faq' %}#headingThree" class="text-decoration-none">Learn more about priority dates →</a>
                </p>
                
                <h6>How to Use This Dashboard</h6>
                <ol>
                    <li>Select your <strong>visa category</strong> (Family-Sponsored or Employment-Based)</li>
                    <li>Choose your <strong>country of chargeability</strong> (birth country, not citizenship)</li>
                    <li>Choose <strong>Final Action</strong> (for green card approval) or <strong>Filing</strong> (to submit I-485). <a href="{% url 'faq' %}#headingTwo" class="text-decoration-none">What's the difference? →</a></li>
                    <li>Enter your application <strong>priority date</strong> to see estimated processing timelines</li>
                </ol>
                
                <h6>Understanding the Chart</h6>
                <ul>
                    <li><strong>Solid lines</strong>: Historical priority date cutoffs for each visa class</li>
                    <li><strong>Red dashed line</strong>: Your application's priority date</li>
                    <li><strong>Dashed projection lines</strong>: Projected timelines for each visa class based on recent trends</li>
                    <li><strong>Click on any data point</strong>: Opens the official visa bulletin for that month</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-question-circle"></i> <strong>Have questions?</strong> 
                    Check out our <a href="{% url 'faq' %}" class="alert-link">Frequently Asked Questions</a> page 
                    for answers about PERM processing, priority dates, retrogressions, and more.
                </div>
            </div>
        </div>

        <!-- Share Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-share"></i> Share with Community</h5>
            </div>
            <div class="card-body">
                <p>Help others track their priority dates by sharing this tool. <a href="{% url 'about' %}" class="text-decoration-none">Learn more about this project →</a></p>
                <div class="d-flex flex-wrap gap-2">
                    <!-- WhatsApp -->
                    <a href="whatsapp://send?text=Check%20out%20this%20Visa%20Bulletin%20Dashboard%20to%20track%20priority%20dates:%20https://visa-bulletin.us/" 
                       class="btn btn-success">
                        <i class="bi bi-whatsapp"></i> WhatsApp
                    </a>
                    
                    <!-- Telegram -->
                    <a href="https://t.me/share/url?url=https://visa-bulletin.us/&text=Check%20out%20this%20Visa%20Bulletin%20Dashboard%20to%20track%20priority%20dates" 
                       class="btn btn-primary text-white">
                        <i class="bi bi-telegram"></i> Telegram
                    </a>
                    
                    <!-- Twitter/X -->
                    <a href="https://twitter.com/intent/tweet?text=Check%20out%20this%20Visa%20Bulletin%20Dashboard%20to%20track%20priority%20dates&url=https://visa-bulletin.us/" 
                       class="btn btn-dark">
                        <i class="bi bi-twitter-x"></i> Post
                    </a>
                    
                    <!-- Copy Link -->
                    <button onclick="navigator.clipboard.writeText('https://visa-bulletin.us/'); alert('Link copied!')" 
                            class="btn btn-secondary">
                        <i class="bi bi-clipboard"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</main>

<script>
// Auto-submit for dropdowns (but not for date input)
function autoSubmitForm() {
    document.getElementById('filterForm').submit();
}

// Category change needs to update visa classes AND submit
function updateVisaClasses() {
    document.getElementById('filterForm').submit();
}

// Optional: Submit on Enter key in date field
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('submission_date');
    if (dateInput) {
        dateInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('filterForm').submit();
            }
        });
    }
    
    // Show chart when Plotly loads
    document.addEventListener('plotlyLoaded', function() {
        const loading = document.getElementById('chart-loading');
        const plot = document.getElementById('chart-plot');
        if (loading && plot) {
            loading.style.display = 'none';
            plot.style.display = 'block';
        }
    });
});
</script>
{% endblock %}

